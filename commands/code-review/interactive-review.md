> **Recommended Model**: Tier 2 - Claude 4.5 Sonnet

<!-- **Why**: Conversational refinement of existing review document -->

# Interactive PR Review

Interactively refine a PR review document generated by `/review-pr`.

## Input

Accepts:

- Path to a review document (e.g., `.cursor/plans/pr-reviews/{branch}-review.md`)
- No argument = list available reviews in `.cursor/plans/pr-reviews/` and prompt for selection

## Reference

Read `.cursor/commands/code-review/review-pr.md` for the review document format.
Read `.cursor/skills/pr-review/SKILL.md` for severity levels, feedback types, and review language guidelines.
Read `.cursor/skills/git-workflow/SKILL.md` for git workflow conventions.

---

## Process

### 1. Load Review Document

If no path provided:

- List all `.md` files in `.cursor/plans/pr-reviews/` (excluding README.md)
- Display file list with modification dates
- Ask user which review to refine

If path provided:

- Verify file exists
- Load the review document

### 2. Parse Review Sections

Extract items from each section:

- **Major Issues** - Items under `## Major Issues`
- **Minor Issues** - Items under `## Minor Issues`
- **Suggestions** - Items under `## Suggestions`
- **Nits** - Items under `## Nits`
- **Questions** - Items under `## Questions`
- **Praise** - Items under `## Praise`
- **General Feedback** - Items under `## General Feedback`

For each item, extract:

- Title (from `### N. {title}`)
- File path (from `**File**: \`{filepath}\``)
- Line numbers (from `**Line(s)**: {lines}`)
- Description (the body text)
- Suggestion (code block if present)
- Category type (severity-based vs feedback-type)

### 3. Interactive Refinement Loop

For each item (process in current document order):

#### a. Display the Item

````markdown
---

## Item {current}/{total} | {SEVERITY}

### {Title}

**File**: `{filepath}`
**Line(s)**: {lines}

{Description}

**Suggestion:**

```{language}
{suggested code}
```
````

---

````

#### b. Prompt for Action

**For severity-based items (major/minor/suggestion/nit):**
1. **Keep** - Accept this item as-is
2. **Reprioritize** - Change severity (major/minor/suggestion/nit)
3. **Rephrase** - Edit the description or suggestion
4. **Add Context** - Append additional information
5. **Dismiss** - Remove this item from the review
6. **Skip** - Move to next item (come back later)

**For Question items:**
1. **Keep** - Keep question as-is for author to answer
2. **Answer** - Provide the answer (converts to context or dismisses)
3. **Convert** - Convert to feedback item (major/minor/suggestion/nit)
4. **Rephrase** - Edit the question
5. **Dismiss** - Remove (no longer need clarification)
6. **Skip** - Move to next item

**For Praise items:**
1. **Keep** - Accept this praise as-is
2. **Rephrase** - Edit the description
3. **Dismiss** - Remove (upon reflection, not noteworthy enough)
4. **Skip** - Move to next item

#### c. Process User Choice

**If Keep:**
- Mark item as reviewed, no changes
- Move to next item

**If Reprioritize (severity items only):**
- Ask: "New severity? (major/minor/suggestion/nit)"
- Update item's severity classification
- Move to next item

**If Answer (questions only):**
- Ask: "What's the answer?"
- Then ask: "Based on this answer, should we: (convert to feedback/dismiss/keep as answered question)?"
- If convert: Ask for new severity and update description with answer context
- If dismiss: Mark for removal
- If keep: Append answer as context with "**Answer:**" prefix
- Move to next item

**If Convert (questions only):**
- Ask: "Convert to what severity? (major/minor/suggestion/nit)"
- Ask: "Updated description based on the clarification:"
- Move item to appropriate severity section
- Move to next item

**If Rephrase:**
- Ask: "Which part to edit? (title/description/suggestion/all)"
- For each part selected, show current value and prompt for new value
- Apply changes
- Move to next item

**If Add Context:**
- Ask: "Enter additional context to append:"
- Append user's input as a new paragraph after the description
- Optionally prefix with "**Additional context:**"
- Move to next item

**If Dismiss:**
- Ask: "Reason for dismissal? (optional, for your records)"
- Mark item for removal
- Move to next item

**If Skip:**
- Add to "skipped" list to revisit
- Move to next item

### 4. Handle Skipped Items

After processing all items:
- If any items were skipped, ask: "Review skipped items now? (yes/no)"
- If yes, loop through skipped items with same action menu
- Repeat until no skipped items remain or user chooses to finalize

### 5. Final Reorganization and Rewrite

After all items processed, reorganize by:

#### Sort Order:
1. **By filename** (directory-based, descending alphabetical order)
   - `frontend/src/components/Button.tsx` comes before `backend/src/routes/api.ts`
   - Within same directory, alphabetical descending (Z before A)
2. **By line number** (descending within each file)
   - Line 150 before line 50
3. **General feedback last** (items without file/line references)

Rewrite each comment to be concise and informal. Each comment should be fewer than 15 words unless the feedback is complex enough to benefit from an explanation

Example:
```markdown
### **src/backend/bar.ts**
*Line 6*
> nit: This variable should explicitly have a type declaration

> suggestion: replace this with a constant

*Lines 10-17*
> praise: Great use of this pattern!

### **src/backend/foo.ts**
*Line 19*
> major: This logic is incorrect due to it being 0-indexed

### **General Comments**
> praise: X was well done

> minor: Y should eventually be improved

````

### 6. Update Counts

Recalculate the summary counts:

```markdown
| Severity   | Count |
| ---------- | ----- |
| Major      | X     |
| Minor      | Y     |
| Suggestion | Z     |
| Nit        | W     |
| Question   | Q     |
```

Note: Praise items are not counted in the severity table (they're positive feedback, not issues).

Update verdict status:

- If any Major items remain: `CHANGES REQUESTED`
- If any Questions remain unanswered: `NEEDS DISCUSSION`
- If no Major/Questions but Minor/Suggestion/Nit remain: `APPROVED` (with suggestions)
- If all items dismissed or only Praise remains: `APPROVED`

### 7. Save Updated Document

Write the reorganized review back to the same file path.

Display summary:

```
✅ Review updated: {filepath}

Changes:
- Kept: X items
- Reprioritized: Y items
- Rephrased: Z items
- Added context: A items
- Answered: B questions
- Converted: C questions to feedback
- Dismissed: D items

Final counts: {Major} major, {Minor} minor, {Suggestion} suggestions, {Nit} nits, {Question} questions
Praise items: {Praise}
```

---

## User Interaction Examples

### Example 1: Dismissing a False Positive

```
---
## Item 3/8 | MINOR

### Consider extracting magic number
**File**: `frontend/src/components/ReviewCard.tsx`
**Line(s)**: 23

The value `150` for truncation length could be a named constant for clarity.

**Suggestion:** `const MAX_PREVIEW_LENGTH = 150;`
---

Action? (keep/reprioritize/rephrase/add-context/dismiss/skip): dismiss

Reason for dismissal? (optional): This constant is only used once and 150 is self-explanatory in context

✓ Item dismissed
```

### Example 2: Reprioritizing

```
---
## Item 5/12 | NIT

### Missing error boundary
**File**: `frontend/src/App.tsx`
**Line(s)**: 12-45

The main App component doesn't have an error boundary, which could cause the entire app to crash on render errors.
---

Action? (keep/reprioritize/rephrase/add-context/dismiss/skip): reprioritize

New severity? (major/minor/suggestion/nit): major

✓ Changed from NIT to MAJOR
```

### Example 3: Adding Context

```
---
## Item 2/8 | MAJOR

### Missing error handling in API call
**File**: `backend/src/routes/reviews.ts`
**Line(s)**: 45-52

The `fetchReviews` call doesn't handle the case where the API returns a 429 (rate limit).
---

Action? (keep/reprioritize/rephrase/add-context/dismiss/skip): add-context

Enter additional context to append:
This is especially important because our RapidAPI tier has a 100 req/day limit and we've hit it before in production.

✓ Context added
```

### Example 4: Rephrasing

````
---
## Item 1/8 | MAJOR

### You need to add validation
**File**: `backend/src/routes/profile.ts`
**Line(s)**: 30

You forgot to validate the input before processing.
---

Action? (keep/reprioritize/rephrase/add-context/dismiss/skip): rephrase

Which part to edit? (title/description/suggestion/all): all

Current title: "You need to add validation"
New title: Missing input validation

Current description: "You forgot to validate the input before processing."
New description: Input validation is missing for the user profile data. The code should verify that required fields are present and properly formatted before processing.

Current suggestion: (none)
New suggestion (or 'skip'):
```typescript
if (!req.body.email || !isValidEmail(req.body.email)) {
  return res.status(400).json({ error: 'Valid email required' });
}
````

✓ Item rephrased

```

### Example 5: Answering a Question

```

---

## Item 8/12 | QUESTION

### Intentional inclusion of deleted reviews?

**File**: `backend/src/routes/reviews.ts`
**Line(s)**: 67

## The query includes soft-deleted reviews (`deletedAt IS NOT NULL`). Is this intentional for an audit trail, or should these be filtered out for the user-facing response?

Action? (keep/answer/convert/rephrase/dismiss/skip): answer

What's the answer?: Yes, this is intentional - we need the deleted reviews visible for the admin audit log endpoint. The user-facing endpoint filters them out in the transform layer.

Based on this answer, should we: (convert to feedback/dismiss/keep as answered question): dismiss

✓ Question answered and dismissed (no action needed)

```

### Example 6: Converting a Question to Feedback

```

---

## Item 9/12 | QUESTION

### Why the 5-second timeout?

**File**: `backend/src/utils/rapidApi.ts`
**Line(s)**: 45

## The timeout is hardcoded to 5000ms. Is this based on observed latency data, or should it be configurable?

Action? (keep/answer/convert/rephrase/dismiss/skip): convert

Convert to what severity? (major/minor/suggestion/nit): suggestion

Updated description: The timeout is hardcoded to 5000ms. Consider making this configurable via environment variable to allow tuning in different environments.

✓ Converted from QUESTION to SUGGESTION

```

### Example 7: Handling Praise

```

---

## Item 11/12 | PRAISE

### Elegant retry logic with exponential backoff

**File**: `backend/src/utils/rapidApi.ts`
**Line(s)**: 89-112

## The retry wrapper with configurable backoff and jitter is well-designed. Clean separation of concerns and handles edge cases like max retries gracefully.

Action? (keep/rephrase/dismiss/skip): keep

✓ Praise item kept

```

---

## Sorting Algorithm Detail

### Descending Alphabetical by Directory Path

Files are sorted by their full path in **descending** alphabetical order:

```

# Input (unsorted):

backend/src/routes/api.ts:45
frontend/src/App.tsx:12
backend/src/utils/helper.ts:78
frontend/src/components/Button.tsx:30
backend/src/routes/api.ts:20

# Output (sorted):

frontend/src/components/Button.tsx:30
frontend/src/App.tsx:12
backend/src/utils/helper.ts:78
backend/src/routes/api.ts:45
backend/src/routes/api.ts:20

```

### Within Same File: Descending Line Numbers

```

# Same file, different lines:

backend/src/routes/api.ts:45 (comes first)
backend/src/routes/api.ts:20 (comes second)

```

### Rationale

- **Descending alphabetical by path**: Allows reviewer to read bottom-up through the PR, seeing higher-level components first
- **Descending line numbers**: When reviewing a file, start from the end to avoid line number shifts as changes are made
- **General feedback last**: Cross-cutting concerns are reviewed after file-specific items

---

## Edge Cases

| Scenario | Behavior |
|----------|----------|
| Review file doesn't exist | Error: "Review not found at {path}. Run `/review-pr` first." |
| Empty review (no items) | Message: "This review has no items to refine." |
| All items dismissed | Update verdict to APPROVED, note "All items addressed/dismissed" |
| Invalid severity entered | Re-prompt: "Invalid severity. Choose: major/minor/suggestion/nit" |
| User interrupts mid-review | Save progress prompt: "Save changes so far? (yes/no)" |
| Items without file/line | Treat as "General Feedback", sort last |
| Malformed review document | Warning with specific parsing error, attempt to continue |

---

## State Tracking

During the interactive session, maintain state:

```

{
"reviewPath": ".cursor/plans/pr-reviews/branch-review.md",
"originalItems": [...],
"processedItems": [
{
"id": 1,
"category": "severity", // "severity" | "question" | "praise"
"originalType": "minor", // major/minor/suggestion/nit/question/praise
"currentType": "major",
"title": "...",
"file": "...",
"lines": "...",
"description": "...",
"suggestion": "...",
"addedContext": "...",
"answer": "...", // For questions that were answered
"action": "reprioritized", // kept/reprioritized/rephrased/addedContext/answered/converted/dismissed
"dismissed": false
}
],
"skippedIds": [],
"stats": {
"kept": 0,
"reprioritized": 0,
"rephrased": 0,
"addedContext": 0,
"answered": 0,
"converted": 0,
"dismissed": 0
}
}

````

---

## Notes

### Review Language Guidelines

When rephrasing, remind user of guidelines from git-workflow.md:
- Use "we", "I", or "the code" instead of "you"
- Be specific in suggestions
- Provide actionable feedback

### Nit vs Suggestion Distinction

When reprioritizing between `nit` and `suggestion`:
- **Nit**: "I feel strongly about this, but it doesn't really matter" (formatting, naming preferences)
- **Suggestion**: "Here's an idea you could consider" (alternative approaches, optional optimizations)

### Praise Budget

Reviews should have 2-3 praise items maximum. If the review has more, consider dismissing less noteworthy ones during the interactive session.

### Preserving Document Metadata

Keep the header section unchanged:
```markdown
# PR Review: {branch-name}

**Reviewed**: {date}
**Branch**: `{review-branch}`
**Base**: `{parent-branch}`
**Commits**: {commit-count}
**Files Changed**: {file-count}

## Summary
...
````

Only modify:

- Verdict status and counts table
- Issue sections (Major/Minor/Suggestions/Nits/Questions/Praise)
- General Feedback section

### Workflow Integration

After completing interactive review:

1. Review document is ready to share
2. User can copy content to GitHub PR comments
3. Or use document as reference during live review discussion

### Backup

Before modifying, create backup:

```bash
cp {review-file} {review-file}.backup
```

Delete backup after successful save. If error occurs, restore from backup.

---

## Related Commands

| Command      | Relationship                                          |
| ------------ | ----------------------------------------------------- |
| `/review-pr` | Generates the review documents this command processes |
| `/execute`   | Pattern reference for file-processing commands        |
| `/commit`    | Use after review to commit the updated document       |
